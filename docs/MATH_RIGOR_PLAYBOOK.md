# Math Rigor Playbook

This is the required workflow for any change that touches formulas, simulation math, scoring logic, or numeric assumptions.

## Scope

Use this process when modifying:
- Notebook math
- Python research/audit formulas
- TypeScript model/dashboard formulas
- Optimizers, thresholds, or cohort/churn equations
- Statistical assumptions or confidence calculations

## Canonical Order

1. Define the formula contract.
- Write equations, variable meanings, units, and valid input ranges.
- Declare expected behavior (for example monotonicity, bounds, conservation).

2. Prototype and verify in notebook/Python.
- Test deterministic spot values and boundary cases.
- For stochastic logic, run scenario sweeps and check distribution-level behavior.

3. Generate Python golden vectors.
- Source: `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/python/generate_golden_vectors.py`
- Output: `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/fixtures/math_golden_vectors.json`

4. Enforce TypeScript parity against golden vectors.
- Formula module: `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/mathParity.ts`
- Parity test: `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/math_parity_golden.test.ts`

5. Integrate into runtime/dashboard.
- Use validated formulas in model/runtime code.
- Keep formula logic centralized when possible to reduce drift.

6. Run full checks and publish audit note.
- Include assumptions, tolerances, test commands, and known limitations.
- For high-impact parameter changes, run the paper-grade 30-run matrix sweep and review the generated heatmaps.

## Required Commands

```bash
cd /Users/devinsonpena/Desktop/Files/DePin-Stress-Test
npm run generate:golden-vectors
npm run test:parity
npm test
npm run generate:paper-stress-report
```

## Current Coverage (Diagnostics + Decision Tree + Benchmark)

- Diagnostic formulas are centralized in `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/diagnosticViewMath.ts`.
- Decision Tree formulas are centralized in `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/decisionTreeViewMath.ts`.
- Benchmark formulas are centralized in `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/benchmarkViewMath.ts`.
- Python golden vectors are generated by `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/python/generate_golden_vectors.py`.
- Parity is enforced by `/Users/devinsonpena/Desktop/Files/DePin-Stress-Test/src/audit/math_parity_golden.test.ts`.

## Definition Of Done

All of the following must be true:
- Notebook/Python checks pass for touched formulas.
- Golden vectors are regenerated and committed.
- Parity tests pass with agreed tolerances.
- Stress/sensitivity checks run for changed parameters.
- Audit note is updated in PR/docs.

## Audit Note Template

```markdown
### Math Audit
- Change scope:
- Formulas touched:
- Units and assumptions:
- Invariants:
- Golden vectors regenerated: yes/no
- Parity test result:
- Stress/sensitivity result:
- Known limits:
```

## Reusable Skill

For cross-project use, use skill:
- `/Users/devinsonpena/.codex/skills/math-rigor/SKILL.md`
